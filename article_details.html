<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>注册</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="shortcut icon" href="resources/images/favicon.ico" />
		<link rel="stylesheet" href="css/amazeui.min.css" />
		<link href="css/app.css" rel="stylesheet" type="text/css" />

		<script src="js/jquery-2.1.3.min.js" type="text/javascript"></script>
		<script src="js/md5.js" type="text/javascript"></script>
		<script src="js/amazeui.min.js"></script>
		<script src="js/ajax.js" type="text/javascript"></script>

		<script type="text/javascript">
		window.URL = "http://laiber.wenjiangtao.me:3000";
		window.id = getURLParameter('id');
		console.log("parent_post[id]::"+id);
		
		function getURLParameter(name) {
			return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(window.location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
		}
		$.ajax({
			type:"post",
			url:URL+"/mobile_app/posts/get",
			async:true,
			data:{
					"posts[num]": 10,
					"parent_post[id]":id,
					
			},
			dataType:"json",
			success:function(data){
				console.log('data::'+JSON.stringify(data));
				$('#details_title').html(data.parent_post.post.title);
				$('#details_content').html(data.parent_post.post.content);
				$('#details_name').html(data.parent_post.user.name);
				
//				$('#details_id').html(getURLParameter('id'));				
			},
			error:function(data){
				
			}
		});
		
//			$(function() {
//				function getURLParameter(name) {
//						return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(window.location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
//					}
//					//var data =getURLParameter('data');
//				console.log(getURLParameter('title'));
//				$('#details_title').html(getURLParameter('title'));
//				$('#details_content').html(getURLParameter('content'));
//				$('#details_name').html(getURLParameter('name'));
//				$('#details_id').html(getURLParameter('id'));
//			});
		</script>

	</head>

	<body>
		<header data-am-widget="header" class="am-header am-header-default">

			<div class="am-header-left am-header-nav">
				<i class="am-icon-angle-left" onclick="history.back()"></i>
				<a href="#left-link" class="">
					<i></i>
				</a>
			</div>
			<h1 class="am-header-title">

		    <a href="#title-link" class="">帖子</a>

		  </h1>
			<nav data-am-widget="menu" class="am-menu  am-menu-offcanvas1" data-am-menu-offcanvas>
				<a href="javascript: void(0)" class="am-menu-toggle">
				</a>
			</nav>
		</header>

		<span class="pullDownIcon"></span><span class="pullDownLabel">下拉刷新...</span>
		<article class="am-article my-article">
			<p id="details_id" style="display: none;"></p>
			<div class="am-article-hd">
				<h1 class="am-article-title" id="details_title"></h1>
				<p class="am-article-meta" id="details_name"></p>
			</div>

			<div class="am-article-bd">
				<p class="am-article-lead" id="details_content"></p>
			</div>
			<button type="button" class="am-btn am-btn-block" id="comment">评论</button>
		</article>

		
		<div id="wrapper">
		  <div id="scroller">
		   <div id="pullDown">
		   </div>
		   <ul id="thelist">
			<!--在此显示加载的-->
		   </ul>
		   <div id="pullUp">
		    <span class="pullUpIcon"></span><span class="pullUpLabel">上拉加载更多...</span>
		   </div>
		  </div>
		</div>
	
	<script src="js/handlebars.min.js"></script>
	<script type="text/x-handlebars-template" id="tpi-list-item">
			{{#each posts}}
			<li style="list-style-type:none;">
				<article class="am-comment">
					<a href="#link-to-user-home">
						<img src="img/portrait.jpg" alt="" class="am-comment-avatar" width="48" height="48" />
					</a>
		
					<div class="am-comment-main">
						<header class="am-comment-hd">
							<!--<h3 class="am-comment-title">评论标题</h3>-->
							<div class="am-comment-meta">
								<a href="#link-to-user" class="am-comment-author">user.name</a> 评论于
								<time datetime="2013-07-27T04:54:29-07:00" title="2013年7月27日 下午7:54 格林尼治标准时间+0800">{{post.create_at}}</time>
							</div>
						</header>
		
						<div class="am-comment-bd">
							...
						</div>
					</div>
				</article>
				</li>
			{{/each}}
	</script>
	<script src="js/iscroll.js" type="text/javascript"></script>
	<script type="text/javascript">
	//初始化绑定iScroll控件 
	document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
	document.addEventListener('DOMContentLoaded', ldoaded, false);
	URL = "http://laiber.wenjiangtao.me:3000";
	/*
	 * 
	 * 点击评论
	 */
	$(function(){
		$('#comment').click(function(){
			console.log("window.id::"+window.id);
			window.location = "comment.html?id="+window.id;
		})
	})
		
		/*json数据显示*/
		compiler = Handlebars.compile($('#tpi-list-item').html());
		
		var fresh_count = 10;
		function fresh(fresh_type, _id, pull_up) {
		//    	console.log('fresh function()');
		var DATA;
		//pull_up值为true是下拉刷新，false是直接刷新
		switch (fresh_type) {
			case 'refresh':
				if (!pull_up) {
					//    				console.log('type==refresh');
					DATA = {
						"posts[num]": fresh_count
					};
				}
				if (pull_up) {
					console.log('pull up');
					DATA = {
						"posts[num]": fresh_count,
						"posts_for_top[id]": _id
					};
				}
				break;
			case 'load':
				DATA = {
					"posts[num]": fresh_count,
					"posts_for_bottom[id]": _id
				};
				break;
			default:
				break;
		}
		$.ajax({
			type: "post",
			url: URL + "/mobile_app/posts/get",
			async: true,
			data: DATA,
			dataType: "json",
			success: function(data) {
				console.log(JSON.stringify(data));
				var html = _this.compiler(data);
				var list = $('#thelist');
				if (fresh_type === 'refresh') {
					list.children('li').first().before(html);
					localStorage.setItem('top_comment[id]', JSON.stringify(data.posts[0].post.id));
					if (!pull_up) {
						localStorage.setItem('bottom_comment[_id]', getJsonLast(data));
					}
				} else if (fresh_type === 'load') {
					list.append(html);
					localStorage.setItem('bottom_comment[_id]', getJsonLast(data));
				} else {
					list.html(html);
				}
			},
			error: function(data) {
				//    		console.log("errorData:"+data);
			},
			complete: function() {
				_this.resetLoading($el);
				if (fresh_type !== 'load') {
					_this.iScroll.scrollTo(0, topOffset, 800, $.AMUI.iScroll.utils.circular);
				}
			}
		});
	};
		
		/**
	  * 初始化iScroll控件
	  */
	  function loaded() {
	   pullDownEl = document.getElementById('pullDown');
	   pullDownOffset = pullDownEl.offsetHeight;
	   pullUpEl = document.getElementById('pullUp');
	   pullUpOffset = pullUpEl.offsetHeight;
	   myScroll = new iScroll('wrapper', {
	    scrollbarClass: 'myScrollbar', /* 重要样式 */
	    useTransition: false,
	    topOffset: pullDownOffset,
	    onRefresh: function () {
	     if (pullDownEl.className.match('loading')) {
	      pullDownEl.className = '';
	      pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
	     } else if (pullUpEl.className.match('loading')) {
	      pullUpEl.className = '';
	      pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
	     }
	    },
	    onScrollMove: function () {
	     if (this.y > 5 && !pullDownEl.className.match('flip')) {
	      pullDownEl.className = 'flip';
	      pullDownEl.querySelector('.pullDownLabel').innerHTML = '松手开始更新...';
	      this.minScrollY = 0;
	     } else if (this.y < 5 && pullDownEl.className.match('flip')) {
	      pullDownEl.className = '';
	      pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
	      this.minScrollY = -pullDownOffset;
	     } else if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip')) {
	      pullUpEl.className = 'flip';
	      pullUpEl.querySelector('.pullUpLabel').innerHTML = '松手开始更新...';
	      this.maxScrollY = this.maxScrollY;
	     } else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip')) {
	      pullUpEl.className = '';
	      pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
	      this.maxScrollY = pullUpOffset;
	     }
	    },
	    onScrollEnd: function () {
		var _id;
	     if (pullDownEl.className.match('flip')) {
	      pullDownEl.className = 'loading';
	      pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
		  _id = localStorage.getItem('top_comment[_id]');
		  fresh('refresh', _id, true);
     } else if (pullUpEl.className.match('flip')) {
	      pullUpEl.className = 'loading';
	      pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
		  _id=localStorage.getItem('bottom_comment[_id]');
	      fresh('load', _id, false);// Execute custom function (ajax call?)
	     }
	    }
	   });
	   setTimeout(function () { document.getElementById('wrapper').style.left = '0'; }, 800);
	  }

		</script>
	</body>

</html>